<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Dealing with long-running computations · Matte.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="index.html"><img src="assets/logo.png" alt="Matte.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit">Matte.jl</span></div><form class="docs-search" action="search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="index.html">Matte</a></li><li><a class="tocitem" href="g01-getting-started.html">Getting started</a></li><li><span class="tocitem">Guides</span><ul><li><a class="tocitem" href="g02-intro.html">Introduction to Matte</a></li><li><a class="tocitem" href="g03-ui.html">Building UIs</a></li><li><a class="tocitem" href="g04-server.html">Server logic</a></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Displaying data</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="g05a-dataframes.html">DataFrames</a></li><li><a class="tocitem" href="g05b-plots.html">Plots</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">State and side-effects</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="g06a-server-side-state.html">Server-side state</a></li><li><a class="tocitem" href="g06b-side-effects.html">Side effects and manually updating the UI</a></li></ul></li><li class="is-active"><a class="tocitem" href="g07-long-running-computations.html">Dealing with long-running computations</a><ul class="internal"><li><a class="tocitem" href="#The-problem-and-set-up-1"><span>The problem and set up</span></a></li><li><a class="tocitem" href="#How-to-improve-it?-1"><span>How to improve it?</span></a></li><li><a class="tocitem" href="#Improvement-1:-Only-calculate-when-desired-1"><span>Improvement 1: Only calculate when desired</span></a></li><li><a class="tocitem" href="#Improvement-2:-Show-a-loading-animation-1"><span>Improvement 2: Show a loading animation</span></a></li></ul></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="r01-layouts.html">UI Layouts</a></li><li><a class="tocitem" href="r02-input-elements.html">Input elements</a></li><li><a class="tocitem" href="r03-output-elements.html">Output elements</a></li><li><a class="tocitem" href="r04-ui-style.html">Controlling style</a></li><li><a class="tocitem" href="r05-running-creating.html">Running and creating Matte apps</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Guides</a></li><li class="is-active"><a href="g07-long-running-computations.html">Dealing with long-running computations</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="g07-long-running-computations.html">Dealing with long-running computations</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/angusmoore/Matte.jl/blob/master/docs/src/g07-long-running-computations.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="g07-long-running-computations-1"><a class="docs-heading-anchor" href="#g07-long-running-computations-1">Long-running Computations</a><a class="docs-heading-anchor-permalink" href="#g07-long-running-computations-1" title="Permalink"></a></h1><p>This guide combines the previous <a href="g06a-server-side-state.html#g06a-server-side-state-1">two</a> <a href="g06b-side-effects.html#g06b-side-effects-1">guides</a> to provide a design pattern that is helpful for long-running computations. If you haven&#39;t read those guides, do so before continuing here.</p><h2 id="The-problem-and-set-up-1"><a class="docs-heading-anchor" href="#The-problem-and-set-up-1">The problem and set up</a><a class="docs-heading-anchor-permalink" href="#The-problem-and-set-up-1" title="Permalink"></a></h2><p>Suppose we have some long-running computation. It doesn&#39;t have to be <em>super</em> long, but long enough that a user will notice a lag between changing inputs and outputs. Even a second is noticeable, but let&#39;s assume we have something that takes even longer – say 10 seconds.</p><p>The example app <code>long_running</code> simulates this just by using a <code>sleep</code>. Let&#39;s create a copy of that app and fire it up to get a sense of the problem we&#39;re dealing with:</p><pre><code class="language-none">matte_example(&quot;bad_long_running&quot;, &quot;bad_long_running&quot;)
includet(&quot;app.jl&quot;)
run_app(BadLongRunningExample)</code></pre><p>Change one of the sliders and you&#39;ll immediately get a sense of the problem: the UI doesn&#39;t seem to work! It <em>is</em>, it&#39;s just taking a long time to respond. Worse still, because we&#39;re using a slider, moving the slider generates 10s of updates every time the user interacts with it – all the intermediate values that are scrolled through trigger updates too. Each update takes 10 seconds (the <code>sleep</code> we inserted, to simulate some complex calculation). This is intolerable as a user experience.</p><h2 id="How-to-improve-it?-1"><a class="docs-heading-anchor" href="#How-to-improve-it?-1">How to improve it?</a><a class="docs-heading-anchor-permalink" href="#How-to-improve-it?-1" title="Permalink"></a></h2><p>Ideally, we want to make two changes:</p><ol><li>Avoid unnecessary intermediate calculations by <em>only</em> running the calculation when the</li></ol><p>user is happy with their chosen inputs.</p><ol><li><em>Show</em> the user that a calculation is taking place. Have some animation to show that the</li></ol><p>result is being calculated.</p><p>We&#39;ll make these changes to <code>bad_long_running</code> in the next two steps. An example app that implements these changes is available as <code>better_long_running</code>.</p><h2 id="Improvement-1:-Only-calculate-when-desired-1"><a class="docs-heading-anchor" href="#Improvement-1:-Only-calculate-when-desired-1">Improvement 1: Only calculate when desired</a><a class="docs-heading-anchor-permalink" href="#Improvement-1:-Only-calculate-when-desired-1" title="Permalink"></a></h2><p>First, we need to add a button to our <code>ui</code> so that users can trigger the calculation. Let&#39;s change the <code>side_panel</code> of our UI to include such a button:</p><pre><code class="language-none">
function ui()
    sidebar_layout(
        side_panel(
            h1(&quot;Choose two numbers&quot;),
            br(),
            slider(&quot;slider1&quot;, &quot;Number 1&quot;, 0, 100),
            slider(&quot;slider2&quot;, &quot;Number 2&quot;, 0, 100),
            br(),
            button(&quot;calculate&quot;, &quot;Calculate now!&quot;)
        ),
        main_panel(
            ...
        )
    )
end</code></pre><p>And then we need to hook this button up to our calculation. We want to <em>only</em> run the calculation when the button is pushed, that is, when <code>calculate</code> is <code>true</code></p><pre><code class="language-none">function my_sum(slider1, slider2, calculate)
    if calculate
        sleep(10)
        slider1 + slider2
    end
end</code></pre><p>Importantly, if <code>calculate</code> is <code>false</code>, this function returns <code>nothing</code>. <code>nothing</code> has a special role in Matte. Matte will not change the UI if it receives a <code>nothing</code> response. This means whatever our <em>last</em> calculated result was will continue to be displayed, even if the user changes the sliders. Jump over to your web browser and try it out for yourself (if you are using <code>Revise</code>, you should only need to refresh your web browser to see the changes).</p><h2 id="Improvement-2:-Show-a-loading-animation-1"><a class="docs-heading-anchor" href="#Improvement-2:-Show-a-loading-animation-1">Improvement 2: Show a loading animation</a><a class="docs-heading-anchor-permalink" href="#Improvement-2:-Show-a-loading-animation-1" title="Permalink"></a></h2><p>Showing users some visual indication that a calculation being informed will greatly improve the user experience, and discourage users from repeatedly trying to recalculate (think the app isn&#39;t working).</p><p>For this, we&#39;re going to need two UI elements: <code>circular_loader</code> and <code>show_if</code>.</p><p>The first is just a spinning wheel animation, and the second let&#39;s us conditional show that animation.</p><p>Let&#39;s add these to the UI in the main panel:</p><pre><code class="language-none">sidebar_layout(
      side_panel(
        ...
      ),
      main_panel(
          h1(&quot;The sum of your numbers is:&quot;),
          br(),
          text_output(&quot;my_sum&quot;),
          show_if(&quot;loading&quot;,
            circular_loader()
          )
      )
  )</code></pre><p>Now, our circular loader will show up anytime the server-side function <code>loading</code> returns <code>true</code>. But, wait?! What would such a function even look like – we want it to show the animation when we start our long running computation and finish when that computation is finished. We can&#39;t do that from a function!</p><p>This is where <code>update_output</code> from the guide on <a href="g06b-side-effects.html#g06b-side-effects-1">side effects</a> shines. We will <em>manually</em> set the value of <code>loading</code> from <em>inside</em> our long-running function <code>my_sum</code>:</p><pre><code class="language-none">function my_sum(slider1, slider2, calculate, session)
    if calculate
        update_output(&quot;loading&quot;, true, session)
        sleep(10)
        result = slider1 + slider2
        update_output(&quot;loading&quot;, false, session)
        result
    end
end</code></pre><p>(NB: Don&#39;t forget to add <code>using Matte</code> to your server module so that you can access the <code>update_output</code> function from Matte).</p><p>The key here is we manually set <code>loading</code> to true before we start our long running computation (proxied here by <code>sleep(10)</code>). Once that finishes, we again manually <code>update_output</code> for <code>loading</code> to set it to false – hiding our loading animation. And then we, finally, return the result of our computation.</p><p>Go ahead and try it out in your app. When you push the button, a circular loader pops indicating that the app is running a calculation. When it&#39;s finished, it disappears and the new sum is shown.</p><p>For extra credit you could even <em>hide</em> the previous number while the calculation is happening using a <code>hide_if</code> with the <code>id</code> of <code>loading</code>.</p><p>This is a particularly helpful design pattern for plots, which tend to be slow to update and can make UIs feel sluggish if allowed to recompute on every change to inputs.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="g06b-side-effects.html">« Side effects and manually updating the UI</a><a class="docs-footer-nextpage" href="r01-layouts.html">UI Layouts »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 3 March 2020 12:17">Tuesday 3 March 2020</span>. Using Julia version 1.3.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
